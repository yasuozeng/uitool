# 数据库设计 - UI 自动化平台

## 文档信息
- **项目名称**: uiTool1.0
- **文档版本**: v1.0
- **创建日期**: 2025-12-27
- **数据库**: SQLite 3.x

---

## 1. 数据库概述

### 1.1 设计原则

- **规范化**：遵循第三范式，减少数据冗余
- **简洁性**：避免过度设计，满足核心需求即可
- **扩展性**：预留扩展字段，支持后续功能
- **性能**：合理建立索引，提升查询效率

### 1.2 命名规范

| 类型 | 规范 | 示例 |
|-----|------|------|
| 表名 | 小写，下划线分隔 | test_cases |
| 字段名 | 小写，下划线分隔 | created_at |
| 主键 | id | id |
| 外键 | 表名_id | case_id |
| 布尔值 | is_前缀 | is_active |
| 时间戳 | _at后缀 | created_at |

---

## 2. 数据表设计

### 2.1 测试用例表 (test_cases)

存储测试用例的基本信息。

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| id | INTEGER | PK, AUTO | 主键 |
| name | VARCHAR(200) | NOT NULL | 用例名称 |
| description | TEXT | NULL | 用例描述 |
| priority | VARCHAR(10) | NOT NULL | 优先级：P0/P1/P2/P3 |
| tags | VARCHAR(500) | NULL | 标签，逗号分隔 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

**索引**：
```sql
CREATE INDEX idx_test_cases_priority ON test_cases(priority);
CREATE INDEX idx_test_cases_tags ON test_cases(tags);
```

### 2.2 测试步骤表 (test_steps)

存储测试用例的执行步骤。

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| id | INTEGER | PK, AUTO | 主键 |
| case_id | INTEGER | FK, NOT NULL | 所属用例ID |
| step_order | INTEGER | NOT NULL | 步骤顺序 |
| action_type | VARCHAR(50) | NOT NULL | 操作类型 |
| element_locator | VARCHAR(500) | NULL | 元素定位符 |
| locator_type | VARCHAR(20) | NULL | 定位类型：id/xpath/css等 |
| action_params | TEXT | NULL | 操作参数（JSON格式） |
| expected_result | TEXT | NULL | 预期结果 |
| description | VARCHAR(500) | NULL | 步骤描述 |
| created_at | DATETIME | NOT NULL | 创建时间 |
| updated_at | DATETIME | NOT NULL | 更新时间 |

**操作类型枚举**：
| action_type | 说明 |
|------------|------|
| navigate | 页面跳转 |
| click | 点击元素 |
| input | 输入文本 |
| clear | 清除内容 |
| wait | 等待元素 |
| verify_text | 验证文本 |
| verify_element | 验证元素存在 |

**索引**：
```sql
CREATE INDEX idx_test_steps_case ON test_steps(case_id);
CREATE INDEX idx_test_steps_order ON test_steps(case_id, step_order);
```

### 2.3 执行记录表 (executions)

存储测试执行的汇总信息。

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| id | INTEGER | PK, AUTO | 主键 |
| execution_type | VARCHAR(20) | NOT NULL | 执行类型：single/batch |
| browser_type | VARCHAR(20) | NOT NULL | 浏览器类型：chrome/firefox/edge |
| headless | BOOLEAN | NOT NULL DEFAULT 0 | 无头模式 |
| window_size | VARCHAR(50) | NULL | 窗口大小：1920x1080 |
| start_time | DATETIME | NOT NULL | 开始时间 |
| end_time | DATETIME | NULL | 结束时间 |
| total_count | INTEGER | NOT NULL DEFAULT 0 | 用例总数 |
| success_count | INTEGER | NOT NULL DEFAULT 0 | 成功数 |
| fail_count | INTEGER | NOT NULL DEFAULT 0 | 失败数 |
| skip_count | INTEGER | NOT NULL DEFAULT 0 | 跳过数 |
| status | VARCHAR(20) | NOT NULL | 状态：pending/running/completed/failed |
| created_at | DATETIME | NOT NULL | 创建时间 |

**索引**：
```sql
CREATE INDEX idx_executions_status ON executions(status);
CREATE INDEX idx_executions_time ON executions(start_time DESC);
```

### 2.4 执行详情表 (execution_details)

存储每个用例的执行详情。

| 字段名 | 类型 | 约束 | 说明 |
|-------|------|------|------|
| id | INTEGER | PK, AUTO | 主键 |
| execution_id | INTEGER | FK, NOT NULL | 执行记录ID |
| case_id | INTEGER | FK, NOT NULL | 用例ID |
| case_name | VARCHAR(200) | NOT NULL | 用例名称（快照） |
| status | VARCHAR(20) | NOT NULL | 执行状态：success/failed/skipped |
| error_message | TEXT | NULL | 错误信息 |
| error_stack | TEXT | NULL | 错误堆栈 |
| screenshot_path | VARCHAR(500) | NULL | 截图路径 |
| step_logs | TEXT | NULL | 步骤日志（JSON格式） |
| start_time | DATETIME | NOT NULL | 开始时间 |
| end_time | DATETIME | NULL | 结束时间 |
| duration | INTEGER | NULL | 执行时长（毫秒） |
| created_at | DATETIME | NOT NULL | 创建时间 |

**索引**：
```sql
CREATE INDEX idx_execution_details_execution ON execution_details(execution_id);
CREATE INDEX idx_execution_details_case ON execution_details(case_id);
CREATE INDEX idx_execution_details_status ON execution_details(status);
```

---

## 3. ER图

```
┌─────────────┐
│ test_cases  │
├─────────────┤
│ id (PK)     │
│ name        │
│ description │
│ priority    │
│ tags        │
│ created_at  │
└──────┬──────┘
       │
       │ 1:N
       │
┌──────┴──────┐
│ test_steps  │
├─────────────┤
│ id (PK)     │
│ case_id (FK)│
│ step_order  │
│ action_type │
│ element_loc │
│ action_params│
│ expected    │
└─────────────┘

┌─────────────┐         ┌─────────────────┐
│ test_cases  │         │ executions      │
└──────┬──────┘         ├─────────────────┤
       │                │ id (PK)         │
       │ N:1            │ execution_type  │
       │                │ browser_type    │
       │                │ start_time      │
       │                │ end_time        │
       │                │ total_count     │
       │                │ success_count   │
       │                │ status          │
       │                └───────┬─────────┘
       │                        │
       │                        │ 1:N
       ▼                        ▼
┌─────────────────┐   ┌──────────────────┐
│execution_details│   │execution_details │
├─────────────────┤   ├──────────────────┤
│ id (PK)         │   │ execution_id (FK)│
│ execution_id(FK)│   │ case_id (FK)     │
│ case_id (FK)    │   │ status           │
│ status          │   │ error_message    │
│ error_message   │   │ screenshot_path  │
│ screenshot_path │   │ step_logs        │
│ step_logs       │   │ duration         │
│ duration        │   └──────────────────┘
└─────────────────┘
```

---

## 4. SQL初始化脚本

```sql
-- 测试用例表
CREATE TABLE test_cases (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    priority VARCHAR(10) NOT NULL DEFAULT 'P1',
    tags VARCHAR(500),
    created_at DATETIME NOT NULL DEFAULT (datetime('now')),
    updated_at DATETIME NOT NULL DEFAULT (datetime('now'))
);

CREATE INDEX idx_test_cases_priority ON test_cases(priority);
CREATE INDEX idx_test_cases_tags ON test_cases(tags);

-- 测试步骤表
CREATE TABLE test_steps (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    case_id INTEGER NOT NULL,
    step_order INTEGER NOT NULL,
    action_type VARCHAR(50) NOT NULL,
    element_locator VARCHAR(500),
    locator_type VARCHAR(20),
    action_params TEXT,
    expected_result TEXT,
    description VARCHAR(500),
    created_at DATETIME NOT NULL DEFAULT (datetime('now')),
    updated_at DATETIME NOT NULL DEFAULT (datetime('now')),
    FOREIGN KEY (case_id) REFERENCES test_cases(id) ON DELETE CASCADE
);

CREATE INDEX idx_test_steps_case ON test_steps(case_id);
CREATE INDEX idx_test_steps_order ON test_steps(case_id, step_order);

-- 执行记录表
CREATE TABLE executions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    execution_type VARCHAR(20) NOT NULL,
    browser_type VARCHAR(20) NOT NULL,
    headless BOOLEAN NOT NULL DEFAULT 0,
    window_size VARCHAR(50),
    start_time DATETIME NOT NULL DEFAULT (datetime('now')),
    end_time DATETIME,
    total_count INTEGER NOT NULL DEFAULT 0,
    success_count INTEGER NOT NULL DEFAULT 0,
    fail_count INTEGER NOT NULL DEFAULT 0,
    skip_count INTEGER NOT NULL DEFAULT 0,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    created_at DATETIME NOT NULL DEFAULT (datetime('now'))
);

CREATE INDEX idx_executions_status ON executions(status);
CREATE INDEX idx_executions_time ON executions(start_time DESC);

-- 执行详情表
CREATE TABLE execution_details (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    execution_id INTEGER NOT NULL,
    case_id INTEGER NOT NULL,
    case_name VARCHAR(200) NOT NULL,
    status VARCHAR(20) NOT NULL,
    error_message TEXT,
    error_stack TEXT,
    screenshot_path VARCHAR(500),
    step_logs TEXT,
    start_time DATETIME NOT NULL DEFAULT (datetime('now')),
    end_time DATETIME,
    duration INTEGER,
    created_at DATETIME NOT NULL DEFAULT (datetime('now')),
    FOREIGN KEY (execution_id) REFERENCES executions(id) ON DELETE CASCADE,
    FOREIGN KEY (case_id) REFERENCES test_cases(id) ON DELETE CASCADE
);

CREATE INDEX idx_execution_details_execution ON execution_details(execution_id);
CREATE INDEX idx_execution_details_case ON execution_details(case_id);
CREATE INDEX idx_execution_details_status ON execution_details(status);
```

---

## 5. 数据字典

### 5.1 优先级枚举 (priority)

| 值 | 说明 |
|----|------|
| P0 | 最高优先级，核心功能 |
| P1 | 高优先级，重要功能 |
| P2 | 中等优先级，一般功能 |
| P3 | 低优先级，次要功能 |

### 5.2 操作类型枚举 (action_type)

| 值 | 说明 | 参数 |
|----|------|------|
| navigate | 页面跳转 | url |
| click | 点击元素 | - |
| input | 输入文本 | text |
| clear | 清除内容 | - |
| wait | 等待元素 | timeout |
| verify_text | 验证文本 | text |
| verify_element | 验证元素存在 | - |

### 5.3 定位类型枚举 (locator_type)

| 值 | 说明 | 示例 |
|----|------|------|
| id | ID定位 | #username |
| xpath | XPath定位 | //input[@id='username'] |
| css | CSS选择器 | input#username |
| name | Name属性 | input[name='username'] |
| class | Class名称 | .form-control |

### 5.4 执行状态枚举 (status)

| 值 | 说明 |
|----|------|
| pending | 等待执行 |
| running | 执行中 |
| completed | 执行完成 |
| failed | 执行失败 |

### 5.5 用例执行状态 (execution_details.status)

| 值 | 说明 |
|----|------|
| success | 成功 |
| failed | 失败 |
| skipped | 跳过 |

---

## 6. 查询示例

### 6.1 查询用例的步骤

```sql
SELECT *
FROM test_steps
WHERE case_id = ?
ORDER BY step_order;
```

### 6.2 查询执行历史

```sql
SELECT e.*,
       (e.success_count * 100.0 / e.total_count) as pass_rate
FROM executions e
ORDER BY e.start_time DESC
LIMIT 20;
```

### 6.3 查询失败的用例

```sql
SELECT ed.*, tc.name as case_name
FROM execution_details ed
JOIN test_cases tc ON ed.case_id = tc.id
WHERE ed.execution_id = ?
  AND ed.status = 'failed'
ORDER BY ed.start_time;
```

### 6.4 按标签查询用例

```sql
SELECT *
FROM test_cases
WHERE tags LIKE '%登录%'
  OR tags LIKE '%回归%';
```

---

## 7. 数据迁移策略

### 7.1 版本控制

使用数据库版本号管理变更：

```sql
CREATE TABLE schema_version (
    version INTEGER PRIMARY KEY,
    description TEXT,
    applied_at DATETIME NOT NULL DEFAULT (datetime('now'))
);

INSERT INTO schema_version (version, description) VALUES (1, '初始版本');
```

### 7.2 迁移脚本示例

```sql
-- V2: 添加用例作者字段
ALTER TABLE test_cases ADD COLUMN author VARCHAR(100);
UPDATE schema_version SET version = 2, description = '添加用例作者';
```

---

## 8. 备份与恢复

### 8.1 备份

```bash
# SQLite数据库文件备份
cp data/uitool.db data/uitool.db.backup.$(date +%Y%m%d)
```

### 8.2 恢复

```bash
# 恢复备份
cp data/uitool.db.20251227 data/uitool.db
```

---

## 9. 性能优化建议

### 9.1 查询优化

- 使用索引覆盖常用查询条件
- 避免SELECT *，只查询需要的字段
- 使用LIMIT限制返回结果数量

### 9.2 写入优化

- 使用事务批量插入
- 定期VACUUM清理数据库
- 分析慢查询日志

### 9.3 存储优化

- 截图文件单独存储，不存入数据库
- 日志定期归档
- 历史执行记录定期清理
