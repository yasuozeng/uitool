# 接口设计 - UI 自动化平台

## 文档信息
- **项目名称**: uiTool1.0
- **文档版本**: v1.0
- **创建日期**: 2025-12-27
- **协议**: HTTP/1.1
- **数据格式**: JSON

---

## 1. 接口规范

### 1.1 基础信息

**Base URL**: `http://localhost:8000/api/v1`

**请求头**:
```
Content-Type: application/json
Accept: application/json
```

### 1.2 通用响应格式

**成功响应**:
```json
{
  "code": 200,
  "message": "success",
  "data": {}
}
```

**错误响应**:
```json
{
  "code": 400,
  "message": "error message",
  "detail": {
    "field": "error details"
  }
}
```

### 1.3 状态码

| 状态码 | 说明 |
|-------|------|
| 200 | 成功 |
| 201 | 创建成功 |
| 400 | 请求参数错误 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

---

## 2. 测试用例接口

### 2.1 创建用例

**请求**:
```http
POST /api/v1/cases
Content-Type: application/json

{
  "name": "登录-正常场景",
  "description": "验证用户名密码正确时能正常登录",
  "priority": "P0",
  "tags": "登录,回归"
}
```

**响应**:
```json
{
  "code": 201,
  "message": "created",
  "data": {
    "id": 1,
    "name": "登录-正常场景",
    "description": "验证用户名密码正确时能正常登录",
    "priority": "P0",
    "tags": "登录,回归",
    "created_at": "2025-12-27T10:00:00"
  }
}
```

### 2.2 获取用例列表

**请求**:
```http
GET /api/v1/cases?priority=P0&page=1&page_size=20
```

**响应**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 50,
    "page": 1,
    "page_size": 20,
    "items": [
      {
        "id": 1,
        "name": "登录-正常场景",
        "description": "验证用户名密码正确时能正常登录",
        "priority": "P0",
        "tags": "登录,回归",
        "step_count": 5,
        "created_at": "2025-12-27T10:00:00"
      }
    ]
  }
}
```

### 2.3 获取用例详情

**请求**:
```http
GET /api/v1/cases/{id}
```

**响应**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "name": "登录-正常场景",
    "description": "验证用户名密码正确时能正常登录",
    "priority": "P0",
    "tags": "登录,回归",
    "steps": [
      {
        "id": 1,
        "step_order": 1,
        "action_type": "navigate",
        "element_locator": null,
        "locator_type": null,
        "action_params": "{\"url\": \"https://example.com/login\"}",
        "expected_result": null,
        "description": "打开登录页"
      },
      {
        "id": 2,
        "step_order": 2,
        "action_type": "input",
        "element_locator": "#username",
        "locator_type": "css",
        "action_params": "{\"text\": \"testuser\"}",
        "expected_result": null,
        "description": "输入用户名"
      }
    ],
    "created_at": "2025-12-27T10:00:00"
  }
}
```

### 2.4 更新用例

**请求**:
```http
PUT /api/v1/cases/{id}
Content-Type: application/json

{
  "name": "登录-正常场景（更新）",
  "priority": "P1"
}
```

**响应**:
```json
{
  "code": 200,
  "message": "updated",
  "data": {
    "id": 1,
    "name": "登录-正常场景（更新）",
    "priority": "P1",
    "updated_at": "2025-12-27T11:00:00"
  }
}
```

### 2.5 删除用例

**请求**:
```http
DELETE /api/v1/cases/{id}
```

**响应**:
```json
{
  "code": 200,
  "message": "deleted"
}
```

### 2.6 批量删除用例

**请求**:
```http
DELETE /api/v1/cases/batch
Content-Type: application/json

{
  "ids": [1, 2, 3]
}
```

**响应**:
```json
{
  "code": 200,
  "message": "deleted",
  "data": {
    "deleted_count": 3
  }
}
```

---

## 3. 测试步骤接口

### 3.1 添加步骤

**请求**:
```http
POST /api/v1/steps
Content-Type: application/json

{
  "case_id": 1,
  "step_order": 1,
  "action_type": "navigate",
  "element_locator": null,
  "locator_type": null,
  "action_params": "{\"url\": \"https://example.com\"}",
  "expected_result": null,
  "description": "打开首页"
}
```

**响应**:
```json
{
  "code": 201,
  "message": "created",
  "data": {
    "id": 1,
    "case_id": 1,
    "step_order": 1,
    "action_type": "navigate",
    "element_locator": null,
    "locator_type": null,
    "action_params": "{\"url\": \"https://example.com\"}",
    "expected_result": null,
    "description": "打开首页",
    "created_at": "2025-12-27T10:00:00"
  }
}
```

### 3.2 批量保存步骤

**请求**:
```http
PUT /api/v1/cases/{id}/steps
Content-Type: application/json

{
  "steps": [
    {
      "id": 1,
      "step_order": 1,
      "action_type": "navigate",
      "action_params": "{\"url\": \"https://example.com\"}",
      "description": "打开首页"
    },
    {
      "id": 2,
      "step_order": 2,
      "action_type": "click",
      "element_locator": "#login-btn",
      "locator_type": "css",
      "description": "点击登录"
    }
  ]
}
```

**响应**:
```json
{
  "code": 200,
  "message": "saved",
  "data": {
    "saved_count": 2,
    "steps": [...]
  }
}
```

### 3.3 删除步骤

**请求**:
```http
DELETE /api/v1/steps/{id}
```

**响应**:
```json
{
  "code": 200,
  "message": "deleted"
}
```

---

## 4. 执行接口

### 4.1 执行单个用例

**请求**:
```http
POST /api/v1/executions
Content-Type: application/json

{
  "execution_type": "single",
  "case_ids": [1],
  "browser_type": "chrome",
  "headless": false,
  "window_size": "1920x1080"
}
```

**响应**:
```json
{
  "code": 201,
  "message": "created",
  "data": {
    "id": 1,
    "execution_type": "single",
    "browser_type": "chrome",
    "headless": false,
    "window_size": "1920x1080",
    "status": "pending",
    "created_at": "2025-12-27T10:00:00"
  }
}
```

### 4.2 批量执行用例

**请求**:
```http
POST /api/v1/executions
Content-Type: application/json

{
  "execution_type": "batch",
  "case_ids": [1, 2, 3, 4, 5],
  "browser_type": "chrome",
  "headless": true
}
```

**响应**:
```json
{
  "code": 201,
  "message": "created",
  "data": {
    "id": 1,
    "execution_type": "batch",
    "browser_type": "chrome",
    "headless": true,
    "total_count": 5,
    "status": "pending"
  }
}
```

### 4.3 按标签执行

**请求**:
```http
POST /api/v1/executions/by-tag
Content-Type: application/json

{
  "tag": "回归",
  "browser_type": "chrome",
  "headless": false
}
```

**响应**:
```json
{
  "code": 201,
  "message": "created",
  "data": {
    "id": 1,
    "execution_type": "batch",
    "total_count": 10,
    "status": "pending"
  }
}
```

### 4.4 获取执行状态

**请求**:
```http
GET /api/v1/executions/{id}
```

**响应**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "execution_type": "batch",
    "browser_type": "chrome",
    "headless": false,
    "window_size": "1920x1080",
    "start_time": "2025-12-27T10:00:00",
    "end_time": null,
    "total_count": 5,
    "success_count": 3,
    "fail_count": 1,
    "skip_count": 0,
    "status": "running",
    "current_case": {
      "id": 4,
      "name": "登录-正常场景",
      "current_step": 2
    }
  }
}
```

### 4.5 获取执行详情列表

**请求**:
```http
GET /api/v1/executions/{id}/details
```

**响应**:
```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "case_id": 1,
      "case_name": "登录-正常场景",
      "status": "success",
      "error_message": null,
      "screenshot_path": null,
      "duration": 5000,
      "start_time": "2025-12-27T10:00:00",
      "end_time": "2025-12-27T10:00:05"
    },
    {
      "id": 2,
      "case_id": 2,
      "case_name": "登录-密码错误",
      "status": "failed",
      "error_message": "Element not found: #error-message",
      "screenshot_path": "/screenshots/error_1.png",
      "duration": 3000,
      "start_time": "2025-12-27T10:00:05",
      "end_time": "2025-12-27T10:00:08"
    }
  ]
}
```

---

## 5. 报告接口

### 5.1 生成HTML报告

**请求**:
```http
POST /api/v1/reports/html
Content-Type: application/json

{
  "execution_id": 1
}
```

**响应**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "report_path": "/reports/execution_1.html",
    "download_url": "/api/v1/reports/download/execution_1.html"
  }
}
```

### 5.2 下载报告

**请求**:
```http
GET /api/v1/reports/download/{filename}
```

**响应**: 返回HTML文件

### 5.3 获取执行历史

**请求**:
```http
GET /api/v1/executions?page=1&page_size=20
```

**响应**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 100,
    "page": 1,
    "page_size": 20,
    "items": [
      {
        "id": 1,
        "execution_type": "batch",
        "browser_type": "chrome",
        "start_time": "2025-12-27T10:00:00",
        "end_time": "2025-12-27T10:05:00",
        "total_count": 10,
        "success_count": 8,
        "fail_count": 2,
        "pass_rate": 80.0,
        "status": "completed"
      }
    ]
  }
}
```

---

## 6. WebSocket接口（实时日志）

### 6.1 连接

**连接地址**:
```
ws://localhost:8000/api/v1/ws/executions/{execution_id}
```

### 6.2 消息格式

**服务端推送**:
```json
{
  "type": "step_start",
  "data": {
    "case_id": 1,
    "case_name": "登录-正常场景",
    "step_order": 1,
    "action_type": "navigate",
    "timestamp": "2025-12-27T10:00:01"
  }
}
```

```json
{
  "type": "step_success",
  "data": {
    "case_id": 1,
    "step_order": 1,
    "duration": 1000,
    "timestamp": "2025-12-27T10:00:02"
  }
}
```

```json
{
  "type": "step_failed",
  "data": {
    "case_id": 1,
    "step_order": 2,
    "error_message": "Element not found",
    "screenshot": "base64_image...",
    "timestamp": "2025-12-27T10:00:03"
  }
}
```

```json
{
  "type": "log",
  "data": {
    "level": "INFO",
    "message": "正在执行步骤：点击登录按钮",
    "timestamp": "2025-12-27T10:00:02"
  }
}
```

```json
{
  "type": "execution_completed",
  "data": {
    "execution_id": 1,
    "total_count": 5,
    "success_count": 4,
    "fail_count": 1,
    "timestamp": "2025-12-27T10:05:00"
  }
}
```

---

## 7. 错误码定义

| 错误码 | 说明 | 示例 |
|-------|------|------|
| 200 | 成功 | 请求成功 |
| 400 | 请求参数错误 | 缺少必填参数 |
| 404 | 资源不存在 | 用例不存在 |
| 409 | 资源冲突 | 用例名称已存在 |
| 500 | 服务器错误 | 内部错误 |

**错误响应示例**:
```json
{
  "code": 400,
  "message": "validation error",
  "detail": {
    "name": ["field is required"],
    "priority": ["invalid value, must be P0/P1/P2/P3"]
  }
}
```

---

## 8. 数据模型

### 8.1 用例模型

```typescript
interface TestCase {
  id?: number;
  name: string;
  description?: string;
  priority: 'P0' | 'P1' | 'P2' | 'P3';
  tags?: string;
  steps?: TestStep[];
  created_at?: string;
  updated_at?: string;
}
```

### 8.2 步骤模型

```typescript
interface TestStep {
  id?: number;
  case_id?: number;
  step_order: number;
  action_type: string;
  element_locator?: string;
  locator_type?: string;
  action_params?: string; // JSON string
  expected_result?: string;
  description?: string;
}
```

### 8.3 执行模型

```typescript
interface Execution {
  id?: number;
  execution_type: 'single' | 'batch';
  browser_type: 'chrome' | 'firefox' | 'edge';
  headless?: boolean;
  window_size?: string;
  start_time?: string;
  end_time?: string;
  total_count?: number;
  success_count?: number;
  fail_count?: number;
  skip_count?: number;
  status?: string;
}
```

---

## 9. 接口测试示例

### 9.1 使用curl测试

```bash
# 创建用例
curl -X POST http://localhost:8000/api/v1/cases \
  -H "Content-Type: application/json" \
  -d '{
    "name": "登录测试",
    "priority": "P0"
  }'

# 执行用例
curl -X POST http://localhost:8000/api/v1/executions \
  -H "Content-Type: application/json" \
  -d '{
    "execution_type": "single",
    "case_ids": [1],
    "browser_type": "chrome"
  }'

# 查询执行状态
curl http://localhost:8000/api/v1/executions/1
```

### 9.2 使用Postman测试

1. 导入接口集合（待提供）
2. 设置环境变量：`base_url = http://localhost:8000/api/v1`
3. 按顺序执行接口测试
