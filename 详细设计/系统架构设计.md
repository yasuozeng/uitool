# 系统架构设计 - UI 自动化平台

## 文档信息
- **项目名称**: uiTool1.0
- **文档版本**: v1.0
- **创建日期**: 2025-12-27

---

## 1. 架构概述

### 1.1 架构原则

- **前后端分离**：前端负责用户交互，后端负责业务逻辑
- **模块化设计**：功能模块独立，低耦合高内聚
- **可扩展性**：预留扩展接口，支持后续功能增加
- **简单优先**：优先满足核心需求，避免过度设计

### 1.2 系统架构图

```
┌────────────────────────────────────────────────────────────┐
│                        用户界面层                            │
│                    ┌─────────────────┐                      │
│                    │   Vue 3 SPA     │                      │
│                    │  Element Plus   │                      │
│                    └─────────────────┘                      │
│  ┌────────────┐  ┌────────────┐  ┌─────────────────────┐  │
│  │脚本编辑器  │  │执行控制台  │  │     报告中心         │  │
│  └────────────┘  └────────────┘  └─────────────────────┘  │
└───────────────────────────────┬────────────────────────────┘
                                │ HTTP/REST API
┌───────────────────────────────┴────────────────────────────┐
│                      应用服务层                               │
│                    ┌─────────────────┐                      │
│                    │   FastAPI       │                      │
│                    │   Backend       │                      │
│                    └─────────────────┘                      │
│  ┌────────────┐  ┌────────────┐  ┌─────────────────────┐  │
│  │用例管理服务│  │执行引擎服务│  │    报告服务         │  │
│  └────────────┘  └────────────┘  └─────────────────────┘  │
└───────────────────────────────┬────────────────────────────┘
                                │
┌───────────────────────────────┴────────────────────────────┐
│                        数据层                                │
│                    ┌─────────────────┐                      │
│                    │     SQLite      │                      │
│                    │   数据库文件     │                      │
│                    └─────────────────┘                      │
│  ┌────────────┐  ┌────────────┐  ┌─────────────────────┐  │
│  │测试用例表  │  │测试步骤表  │  │   执行记录表         │  │
│  └────────────┘  └────────────┘  └─────────────────────┘  │
└───────────────────────────────┬────────────────────────────┘
                                │
┌───────────────────────────────┴────────────────────────────┐
│                      自动化执行层                            │
│                    ┌─────────────────┐                      │
│                    │    Playwright   │                      │
│                    │   执行引擎      │                      │
│                    └─────────────────┘                      │
│  ┌────────────┐  ┌────────────┐  ┌─────────────────────┐  │
│  │  Chrome    │  │  Firefox   │  │       Edge          │  │
│  │  Driver    │  │  Driver    │  │      Driver         │  │
│  └────────────┘  └────────────┘  └─────────────────────┘  │
└────────────────────────────────────────────────────────────┘
```

---

## 2. 技术选型

### 2.1 前端技术栈

| 技术 | 版本 | 说明 |
|-----|------|------|
| Vue | 3.x | 渐进式JavaScript框架 |
| Vite | 5.x | 前端构建工具 |
| Element Plus | Latest | Vue 3 UI组件库 |
| Monaco Editor | Latest | VS Code同款代码编辑器 |
| Pinia | Latest | Vue状态管理 |
| Vue Router | 4.x | 路由管理 |
| Axios | Latest | HTTP客户端 |

**选型理由**：
- Vue 3：轻量、易学、生态完善
- Element Plus：组件丰富、文档完善
- Monaco Editor：功能强大、VS Code同款
- Vite：开发体验好、构建速度快

### 2.2 后端技术栈

| 技术 | 版本 | 说明 |
|-----|------|------|
| Python | 3.10+ | 编程语言 |
| FastAPI | Latest | 现代化Web框架 |
| Pydantic | Latest | 数据验证 |
| SQLAlchemy | Latest | ORM框架 |
| Playwright | Latest | 自动化测试引擎 |
| uvicorn | Latest | ASGI服务器 |

**选型理由**：
- FastAPI：高性能、易开发、自动API文档
- Playwright：现代化、跨浏览器、API友好
- SQLite：轻量、无需部署、易于开发

### 2.3 开发工具

| 工具 | 说明 |
|-----|------|
| Git | 版本控制 |
| VS Code | 代码编辑器 |
| Postman | API测试 |

---

## 3. 模块设计

### 3.1 前端模块

```
src/
├── main.ts                 # 应用入口
├── App.vue                 # 根组件
├── router/                 # 路由配置
│   └── index.ts
├── store/                  # 状态管理
│   └── index.ts
├── api/                    # API接口
│   ├── case.ts            # 用例接口
│   ├── execution.ts       # 执行接口
│   └── report.ts          # 报告接口
├── components/             # 公共组件
│   ├── StepEditor.vue     # 步骤编辑器
│   ├── StepList.vue       # 步骤列表
│   ├── ExecutionLog.vue   # 执行日志
│   └── ScreenshotViewer.vue # 截图查看器
└── views/                  # 页面组件
    ├── CaseManagement.vue # 用例管理
    ├── ScriptEditor.vue   # 脚本编辑
    ├── ExecutionConsole.vue # 执行控制台
    └── ReportCenter.vue   # 报告中心
```

### 3.2 后端模块

```
app/
├── main.py                 # 应用入口
├── config.py               # 配置文件
├── api/                    # API路由
│   ├── cases.py           # 用例路由
│   ├── executions.py      # 执行路由
│   └── reports.py         # 报告路由
├── models/                 # 数据模型
│   ├── database.py        # 数据库连接
│   ├── case.py            # 用例模型
│   ├── execution.py       # 执行模型
│   └── report.py          # 报告模型
├── services/               # 业务逻辑
│   ├── case_service.py    # 用例服务
│   ├── execution_service.py # 执行服务
│   └── report_service.py  # 报告服务
├── engines/                # 执行引擎
│   └── playwright_engine.py # Playwright引擎
└── schemas/                # 数据模式
    ├── case.py            # 用例模式
    ├── execution.py       # 执行模式
    └── report.py          # 报告模式
```

---

## 4. 接口设计规范

### 4.1 RESTful API 设计

**基础URL**：`http://localhost:8000/api/v1`

**通用响应格式**：
```json
{
  "code": 200,
  "message": "success",
  "data": {}
}
```

**错误响应格式**：
```json
{
  "code": 400,
  "message": "error message",
  "detail": {}
}
```

### 4.2 HTTP状态码

| 状态码 | 说明 |
|-------|------|
| 200 | 成功 |
| 201 | 创建成功 |
| 400 | 请求错误 |
| 404 | 资源不存在 |
| 500 | 服务器错误 |

---

## 5. 数据流转

### 5.1 创建测试用例流程

```
用户操作                前端                后端              数据库
   │                    │                   │                 │
   ├─新建用例─────────> │                   │                 │
   │                    ├─POST /api/cases──>│                 │
   │                    │                   ├─INSERT          │
   │                    │                   │                 │
   │<─返回用例ID────────┴<──────────────────┴<─SELECT         │
   │                    │                   │                 │
   ├─添加步骤─────────> │                   │                 │
   │                    ├─POST /api/steps─>│                 │
   │                    │                   ├─INSERT          │
   │                    │                   │                 │
   │<─返回步骤列表───────┴<──────────────────┴<─SELECT         │
```

### 5.2 执行测试用例流程

```
用户操作                前端                后端           Playwright      浏览器
   │                    │                   │                 │            │
   ├─点击执行─────────> │                   │                 │            │
   │                    ├─POST /executions─>│                 │            │
   │                    │                   ├─创建执行记录    │            │
   │                    │                   │                 │            │
   │<─开始WebSocket─────┴<───────────────────┴<─启动Playwright>│            │
   │                    │                   │                 │            │
   │                    │                   │                 ├─启动──────>│
   │                    │                   │                 │            │
   │                    │                   │                 │<─执行──────┤
   │                    │                   │                 │            │
   │<─实时日志更新───────┴<───────────────────┴<─推送日志──────┴────────────┤
   │                    │                   │                 │            │
   │                    │                   │                 ├─截图──────>│
   │                    │                   │                 │            │
   │<─执行结果───────────┴<───────────────────┴<─保存结果──────┴────────────┤
```

---

## 6. 部署架构

### 6.1 开发环境

```
┌─────────────────────────────────┐
│         开发机                    │
│  ┌──────────────┐  ┌────────────┐│
│  │ 前端dev server│  │后端API server││
│  │   :5173      │  │   :8000     ││
│  └──────────────┘  └────────────┘│
│         │                 │       │
│         └────────┬────────┘       │
│                  │                │
│  ┌───────────────┴──────────────┐│
│  │      SQLite 数据库文件         ││
│  │      uitool.db                ││
│  └───────────────────────────────┘│
└─────────────────────────────────┘
```

### 6.2 生产环境（简化版）

```
┌─────────────────────────────────┐
│         单机部署                  │
│  ┌──────────────┐  ┌────────────┐│
│  │ Nginx (可选) │  │  后端服务   ││
│  │   静态文件    │  │  :8000     ││
│  └──────────────┘  └────────────┘│
│                           │       │
│  ┌────────────────────────┴──────┐│
│  │      SQLite 数据库文件          ││
│  │      /data/uitool.db           ││
│  └───────────────────────────────┘│
└─────────────────────────────────┘
```

---

## 7. 安全考虑

### 7.1 前端安全

- 输入验证：所有用户输入进行验证
- XSS防护：使用Vue的自动转义
- CSRF防护：使用CSRF Token（后续实现）

### 7.2 后端安全

- 输入验证：使用Pydantic进行数据验证
- SQL注入：使用SQLAlchemy ORM
- 文件上传：限制文件类型和大小
- 错误处理：不暴露敏感信息

### 7.3 数据安全

- 数据备份：定期备份数据库文件
- 敏感数据：不记录敏感信息（如密码）

---

## 8. 性能优化

### 8.1 前端优化

- 代码分割：使用动态import
- 组件懒加载：路由级别的懒加载
- 虚拟滚动：大列表使用虚拟滚动

### 8.2 后端优化

- 异步处理：使用FastAPI的异步特性
- 数据库索引：关键字段建立索引
- 缓存：常用数据缓存（内存）

### 8.3 执行优化

- 并发执行：多浏览器并发执行
- 资源复用：浏览器实例复用
- 失败快速退出：失败后立即停止

---

## 9. 扩展性设计

### 9.1 插件机制（预留）

```python
# 插件接口定义
class ActionPlugin:
    def execute(self, browser, params):
        pass

# 注册插件
plugin_manager.register('custom_action', CustomActionPlugin())
```

### 9.2 自定义操作类型（预留）

```javascript
// 前端扩展
const customActions = [
  {
    type: 'swipe',
    name: '滑动操作',
    params: ['direction', 'distance']
  }
]
```

### 9.3 报告模板（预留）

```python
# 报告生成器接口
class ReportGenerator:
    def generate(self, execution_data, template):
        pass
```

---

## 10. 技术风险评估

| 风险 | 影响 | 概率 | 缓解措施 |
|-----|------|------|---------|
| Playwright API变更 | 高 | 低 | 固定版本，定期评估 |
| SQLite并发限制 | 中 | 中 | 使用队列，限制并发 |
| 大文件上传性能 | 中 | 低 | 限制文件大小 |
| 前端兼容性 | 低 | 中 | 使用现代浏览器 |
